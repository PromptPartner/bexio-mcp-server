---
phase: 02-reference-data-banking
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/schemas/banking.ts
  - src/types/schemas/index.ts
  - src/tools/banking/definitions.ts
  - src/tools/banking/handlers.ts
  - src/tools/banking/index.ts
  - src/tools/index.ts
  - src/bexio-client.ts
autonomous: true

must_haves:
  truths:
    - "User can list bank accounts"
    - "User can get a specific bank account"
    - "User can list currencies"
    - "User can get, create, update, and delete currencies"
    - "User can create IBAN payments with structured recipient addresses"
    - "User can get and update IBAN payments"
    - "User can create QR payments (Swiss QR-invoice standard)"
    - "User can get and update QR payments"
  artifacts:
    - path: "src/types/schemas/banking.ts"
      provides: "Zod schemas for banking and payment tools"
      exports: ["ListBankAccountsParamsSchema", "GetBankAccountParamsSchema", "ListCurrenciesParamsSchema", "GetCurrencyParamsSchema", "CreateCurrencyParamsSchema", "UpdateCurrencyParamsSchema", "DeleteCurrencyParamsSchema", "CreateIbanPaymentParamsSchema", "GetIbanPaymentParamsSchema", "UpdateIbanPaymentParamsSchema", "CreateQrPaymentParamsSchema", "GetQrPaymentParamsSchema", "UpdateQrPaymentParamsSchema"]
    - path: "src/tools/banking/definitions.ts"
      provides: "MCP tool definitions for banking domain"
      min_lines: 150
    - path: "src/tools/banking/handlers.ts"
      provides: "Handler implementations for banking tools"
      exports: ["handlers"]
    - path: "src/tools/banking/index.ts"
      provides: "Barrel export for banking domain"
      exports: ["toolDefinitions", "handlers"]
  key_links:
    - from: "src/tools/banking/handlers.ts"
      to: "src/bexio-client.ts"
      via: "client method calls"
      pattern: "client\\.(list|get|create|update|delete)(BankAccount|Currency|IbanPayment|QrPayment)"
    - from: "src/tools/index.ts"
      to: "src/tools/banking/index.ts"
      via: "import and spread"
      pattern: "import.*banking.*from.*banking"
---

<objective>
Implement Swiss banking and payment tools: bank accounts (read-only), currencies (full CRUD), IBAN payments, and QR payments.

Purpose: Enable users to manage multi-currency invoicing and create Swiss-standard payments (ISO 20022 IBAN and QR-bill formats). This is critical for Swiss businesses using Bexio.

Output:
- 13 new MCP tools (2 bank accounts + 5 currencies + 3 IBAN payments + 3 QR payments)
- New `tools/banking/` domain module
- New `types/schemas/banking.ts` schema file
- BexioClient methods for all banking endpoints

Key Swiss Standards:
- IBAN payments: Follow Swiss ISO 20022 payment standards
- QR payments: Follow SIX Group QR-bill specification v2.3
- Addresses: Use structured format only (type S) - required from Nov 2025
</objective>

<execution_context>
@C:\Users\calvi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\calvi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-reference-data-banking/02-RESEARCH.md
@src/tools/contacts/definitions.ts
@src/tools/contacts/handlers.ts
@src/tools/index.ts
@src/types/schemas/contacts.ts
@src/bexio-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create banking Zod schemas</name>
  <files>
    src/types/schemas/banking.ts
    src/types/schemas/index.ts
  </files>
  <action>
Create `src/types/schemas/banking.ts` with Zod schemas for all banking operations.

**Bank Accounts (BANK-01) - Read Only:**
```typescript
export const ListBankAccountsParamsSchema = z.object({
  limit: z.number().int().positive().default(100),
  offset: z.number().int().min(0).default(0),
});

export const GetBankAccountParamsSchema = z.object({
  account_id: z.number().int().positive(),
});
```

**Currencies (BANK-02) - Full CRUD:**
```typescript
export const ListCurrenciesParamsSchema = z.object({
  limit: z.number().int().positive().default(100),
  offset: z.number().int().min(0).default(0),
});

export const GetCurrencyParamsSchema = z.object({
  currency_id: z.number().int().positive(),
});

export const CreateCurrencyParamsSchema = z.object({
  name: z.string().min(1).max(10),
  round_factor: z.number().positive().default(0.05), // Swiss 5 rappen default
});

export const UpdateCurrencyParamsSchema = z.object({
  currency_id: z.number().int().positive(),
  currency_data: z.record(z.unknown()),
});

export const DeleteCurrencyParamsSchema = z.object({
  currency_id: z.number().int().positive(),
});
```

**IBAN Payments (BANK-03):**
```typescript
// Structured recipient address (required from Nov 2025)
const RecipientSchema = z.object({
  name: z.string().max(70),
  street: z.string().max(70).optional(),
  house_number: z.string().max(16).optional(),
  zip: z.string().max(10),
  city: z.string().max(35),
  country_code: z.string().length(2).default("CH"),
});

export const CreateIbanPaymentParamsSchema = z.object({
  bank_account_id: z.number().int().positive(),
  iban: z.string().min(15).max(34),
  currency: z.enum(["CHF", "EUR"]),
  amount: z.number().positive(),
  recipient_name: z.string().max(70),
  recipient_street: z.string().max(70).optional(),
  recipient_house_number: z.string().max(16).optional(),
  recipient_zip: z.string().max(10),
  recipient_city: z.string().max(35),
  recipient_country_code: z.string().length(2).default("CH"),
  execution_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  message: z.string().max(140).optional(),
  is_salary_payment: z.boolean().default(false),
  allowance_type: z.enum(["no_fee", "our", "ben", "sha"]).default("no_fee"),
});

export const GetIbanPaymentParamsSchema = z.object({
  payment_id: z.number().int().positive(),
});

export const UpdateIbanPaymentParamsSchema = z.object({
  payment_id: z.number().int().positive(),
  payment_data: z.record(z.unknown()),
});
```

**QR Payments (BANK-04):**
```typescript
export const CreateQrPaymentParamsSchema = z.object({
  bank_account_id: z.number().int().positive(),
  iban: z.string().min(15).max(34),
  currency: z.enum(["CHF", "EUR"]),
  amount: z.number().positive().max(999999999.99),
  recipient_name: z.string().max(70),
  recipient_street: z.string().max(70).optional(),
  recipient_house_number: z.string().max(16).optional(),
  recipient_zip: z.string().max(10),
  recipient_city: z.string().max(35),
  recipient_country_code: z.string().length(2).default("CH"),
  execution_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  qr_reference_nr: z.string().length(27).regex(/^\d+$/).optional(),
  additional_information: z.string().max(140).optional(),
});

export const GetQrPaymentParamsSchema = z.object({
  payment_id: z.number().int().positive(),
});

export const UpdateQrPaymentParamsSchema = z.object({
  payment_id: z.number().int().positive(),
  payment_data: z.record(z.unknown()),
});
```

Export all types with `z.infer<typeof Schema>` pattern.

Update `src/types/schemas/index.ts` to export from `banking.ts`.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep -c "Schema" src/types/schemas/banking.ts` shows 13+ schemas
    - `grep "banking" src/types/schemas/index.ts` shows export
  </verify>
  <done>
    - All 13 Zod schemas created with proper validation
    - Structured address format enforced
    - Swiss-specific constraints included (currency, field lengths)
    - TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add BexioClient banking methods</name>
  <files>
    src/bexio-client.ts
  </files>
  <action>
Add BexioClient methods for all banking endpoints. Add after company methods, before ORDERS section.

```typescript
// ===== BANK ACCOUNTS (Read-Only) =====
async listBankAccounts(params: PaginationParams = {}): Promise<unknown[]> {
  return this.makeRequest("GET", "/bank_account", params);
}

async getBankAccount(accountId: number): Promise<unknown> {
  return this.makeRequest("GET", `/bank_account/${accountId}`);
}

// ===== CURRENCIES =====
async listCurrencies(params: PaginationParams = {}): Promise<unknown[]> {
  return this.makeRequest("GET", "/currency", params);
}

async getCurrency(currencyId: number): Promise<unknown> {
  return this.makeRequest("GET", `/currency/${currencyId}`);
}

async createCurrency(data: { name: string; round_factor: number }): Promise<unknown> {
  return this.makeRequest("POST", "/currency", undefined, data);
}

async updateCurrency(currencyId: number, data: Record<string, unknown>): Promise<unknown> {
  return this.makeRequest("PATCH", `/currency/${currencyId}`, undefined, data);
}

async deleteCurrency(currencyId: number): Promise<unknown> {
  return this.makeRequest("DELETE", `/currency/${currencyId}`);
}

// ===== IBAN PAYMENTS (Swiss ISO 20022) =====
async createIbanPayment(data: {
  bank_account_id: number;
  iban: string;
  instructed_amount: { currency: string; amount: number };
  recipient: {
    name: string;
    street?: string;
    house_number?: string;
    zip: string;
    city: string;
    country_code: string;
  };
  execution_date: string;
  message?: string;
  is_salary_payment?: boolean;
  allowance_type?: string;
}): Promise<unknown> {
  return this.makeRequest("POST", "/iban_payment", undefined, data);
}

async getIbanPayment(paymentId: number): Promise<unknown> {
  return this.makeRequest("GET", `/iban_payment/${paymentId}`);
}

async updateIbanPayment(paymentId: number, data: Record<string, unknown>): Promise<unknown> {
  return this.makeRequest("PATCH", `/iban_payment/${paymentId}`, undefined, data);
}

// ===== QR PAYMENTS (Swiss QR-invoice standard) =====
async createQrPayment(data: {
  bank_account_id: number;
  iban: string;
  instructed_amount: { currency: string; amount: number };
  recipient: {
    name: string;
    street?: string;
    house_number?: string;
    zip: string;
    city: string;
    country_code: string;
  };
  execution_date: string;
  qr_reference_nr?: string;
  additional_information?: string;
}): Promise<unknown> {
  return this.makeRequest("POST", "/qr_payment", undefined, data);
}

async getQrPayment(paymentId: number): Promise<unknown> {
  return this.makeRequest("GET", `/qr_payment/${paymentId}`);
}

async updateQrPayment(paymentId: number, data: Record<string, unknown>): Promise<unknown> {
  return this.makeRequest("PATCH", `/qr_payment/${paymentId}`, undefined, data);
}
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep "listBankAccounts\|createIbanPayment\|createQrPayment" src/bexio-client.ts` shows new methods
  </verify>
  <done>
    - 13 BexioClient methods added for banking endpoints
    - Structured payment data format used
    - TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Create banking domain tool definitions and handlers</name>
  <files>
    src/tools/banking/definitions.ts
    src/tools/banking/handlers.ts
    src/tools/banking/index.ts
    src/tools/index.ts
  </files>
  <action>
Create the `tools/banking/` domain following the established pattern.

**Create `src/tools/banking/definitions.ts`:**
Define 13 MCP tools:

Bank Accounts (2 tools - read only):
- `list_bank_accounts` - List all configured bank accounts
- `get_bank_account` - Get a specific bank account by ID

Currencies (5 tools):
- `list_currencies` - List all currencies with pagination
- `get_currency` - Get a specific currency by ID
- `create_currency` - Create a new currency (name, round_factor)
- `update_currency` - Update currency settings
- `delete_currency` - Delete a currency by ID

IBAN Payments (3 tools):
- `create_iban_payment` - Create IBAN payment (Swiss ISO 20022)
  Requires: bank_account_id, iban, currency, amount, recipient details, execution_date
  Optional: message, is_salary_payment, allowance_type
- `get_iban_payment` - Get payment details by ID
- `update_iban_payment` - Update pending payment

QR Payments (3 tools):
- `create_qr_payment` - Create QR payment (Swiss QR-invoice)
  Requires: bank_account_id, iban, currency, amount, recipient details, execution_date
  Optional: qr_reference_nr (27 digits), additional_information
- `get_qr_payment` - Get payment details by ID
- `update_qr_payment` - Update pending payment

Important: Payment tool descriptions should mention:
- Use `list_bank_accounts` first to get valid bank_account_id
- Only structured addresses (street, house_number, zip, city) are accepted
- QR reference must be 27 digits if provided
- Currency must be CHF or EUR

**Create `src/tools/banking/handlers.ts`:**
Implement handlers for all 13 tools. Payment handlers must transform flat params to nested structure:

```typescript
create_iban_payment: async (client, args) => {
  const params = CreateIbanPaymentParamsSchema.parse(args);

  // Transform flat params to Bexio API structure
  const paymentData = {
    bank_account_id: params.bank_account_id,
    iban: params.iban,
    instructed_amount: {
      currency: params.currency,
      amount: params.amount,
    },
    recipient: {
      name: params.recipient_name,
      street: params.recipient_street,
      house_number: params.recipient_house_number,
      zip: params.recipient_zip,
      city: params.recipient_city,
      country_code: params.recipient_country_code,
    },
    execution_date: params.execution_date,
    message: params.message,
    is_salary_payment: params.is_salary_payment,
    allowance_type: params.allowance_type,
  };

  return client.createIbanPayment(paymentData);
},
```

Similar pattern for `create_qr_payment`.

**Create `src/tools/banking/index.ts`:**
Barrel export.

**Update `src/tools/index.ts`:**
Add banking domain to imports and aggregation:
```typescript
import * as banking from "./banking/index.js";
// ...
const allDefinitions: Tool[] = [
  ...reference.toolDefinitions,  // 28 tools
  ...company.toolDefinitions,    // 6 tools
  ...banking.toolDefinitions,    // 13 tools
  ...contacts.toolDefinitions,   // 7 tools
  // ... rest
];
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep -c "name:" src/tools/banking/definitions.ts` shows 13 (one per tool)
    - `ls src/tools/banking/` shows definitions.ts, handlers.ts, index.ts
    - `grep "banking" src/tools/index.ts` shows import and usage
  </verify>
  <done>
    - 13 tool definitions created with clear descriptions
    - 13 handlers implemented with proper data transformation
    - Swiss payment standards documented in descriptions
    - Barrel export in index.ts
    - Banking domain registered in tools/index.ts
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` compiles successfully
2. 13 new banking tools registered
3. Phase 2 total: 47 new tools (28 reference + 6 company + 13 banking)
4. Overall total: 130 tools (83 existing + 47 new)
5. Payment tools transform flat params to nested API structure
6. Swiss standards documented in tool descriptions
7. No TypeScript errors
</verification>

<success_criteria>
- BANK-01: Bank accounts tools (list, get) implemented - read-only as per API
- BANK-02: Currencies tools (list, get, create, update, delete) implemented
- BANK-03: IBAN payment tools (create, get, update) implemented with structured addresses
- BANK-04: QR payment tools (create, get, update) implemented with QR reference support
- All tools follow established domain module pattern
- TypeScript compiles without errors
- Swiss ISO 20022 and QR-bill requirements documented
</success_criteria>

<output>
After completion, create `.planning/phases/02-reference-data-banking/02-03-SUMMARY.md`
</output>
