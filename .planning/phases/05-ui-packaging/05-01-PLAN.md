---
phase: 05-ui-packaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/package.json
  - src/server.ts
  - src/ui/invoice-preview/invoice-preview.html
  - src/ui/invoice-preview/mcp-app.ts
  - src/ui/contact-card/contact-card.html
  - src/ui/contact-card/mcp-app.ts
  - src/ui/dashboard/dashboard.html
  - src/ui/dashboard/mcp-app.ts
  - src/ui-resources.ts
  - vite.config.ts
autonomous: true

must_haves:
  truths:
    - "Server declares MCP Apps capability with ui:// resources"
    - "preview_invoice tool returns invoice data with UI resource link"
    - "show_contact_card tool returns contact data with UI resource link"
    - "show_dashboard tool returns summary data with UI resource link"
    - "UI HTML files bundle correctly as single-file assets"
  artifacts:
    - path: "src/ui-resources.ts"
      provides: "MCP Apps resource registration using ext-apps SDK"
      exports: ["registerUIResources"]
    - path: "src/ui/invoice-preview/invoice-preview.html"
      provides: "Invoice preview HTML template"
      min_lines: 50
    - path: "src/ui/contact-card/contact-card.html"
      provides: "Contact card HTML template"
      min_lines: 40
    - path: "vite.config.ts"
      provides: "Vite bundling configuration for UI single-file output"
      contains: "viteSingleFile"
  key_links:
    - from: "src/server.ts"
      to: "src/ui-resources.ts"
      via: "import and call registerUIResources"
      pattern: "registerUIResources"
    - from: "src/ui-resources.ts"
      to: "@modelcontextprotocol/ext-apps/server"
      via: "SDK import"
      pattern: "registerAppTool.*registerAppResource"
---

<objective>
Implement MCP Apps UI resources for interactive invoice preview, contact card, and dashboard summary.

Purpose: Enable Claude to render rich interactive UIs inline in conversations when users request invoice previews, contact cards, or dashboard summaries, rather than plain text responses.

Output: Three UI tools (preview_invoice, show_contact_card, show_dashboard) with corresponding HTML resources served via ui:// scheme.
</objective>

<execution_context>
@C:\Users\calvi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\calvi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ui-packaging/05-RESEARCH.md

# Existing patterns
@src/server.ts
@src/tools/index.ts
@src/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MCP Apps dependencies and configure Vite</name>
  <files>src/package.json, vite.config.ts</files>
  <action>
1. Add dev dependencies to src/package.json:
   - @modelcontextprotocol/ext-apps ^1.0.1 (MCP Apps SDK)
   - vite ^6.0.0 (UI bundling)
   - vite-plugin-singlefile ^3.0.0 (single-file HTML output)
   - concurrently ^8.0.0 (dev workflow)

2. Add npm scripts to src/package.json:
   - "build:ui": "vite build"
   - "build": "tsc && npm run build:ui" (update existing)
   - "dev:ui": "vite build --watch"

3. Create vite.config.ts at src/vite.config.ts:
   - Use defineConfig from vite
   - Add viteSingleFile plugin
   - Configure build.outDir as "../dist/ui" (relative to src/)
   - Configure rollupOptions.input with three HTML entry points:
     - "invoice-preview": "src/ui/invoice-preview/invoice-preview.html"
     - "contact-card": "src/ui/contact-card/contact-card.html"
     - "dashboard": "src/ui/dashboard/dashboard.html"
   - Set root to "." since vite.config.ts is in src/

Note: vite.config.ts goes in src/ because that's where package.json is.
  </action>
  <verify>npm install succeeds in src/ directory; vite --version returns 6.x</verify>
  <done>Dependencies installed, vite.config.ts created with single-file bundling config</done>
</task>

<task type="auto">
  <name>Task 2: Create UI HTML templates and client scripts</name>
  <files>
    src/ui/invoice-preview/invoice-preview.html
    src/ui/invoice-preview/mcp-app.ts
    src/ui/contact-card/contact-card.html
    src/ui/contact-card/mcp-app.ts
    src/ui/dashboard/dashboard.html
    src/ui/dashboard/mcp-app.ts
  </files>
  <action>
1. Create src/ui/ directory structure:
   - src/ui/invoice-preview/
   - src/ui/contact-card/
   - src/ui/dashboard/

2. Create invoice-preview.html:
   - DOCTYPE html with meta charset UTF-8
   - Inline CSS styles for invoice layout (max-width: 800px, centered)
   - Header section (invoice number, title, dates)
   - Contact section (bill-to name, email)
   - Line items table (description, qty, price, amount)
   - Total section (gross total with currency)
   - Status badge based on kb_item_status_id
   - Script module import for mcp-app.ts

3. Create invoice-preview/mcp-app.ts:
   - Import App from @modelcontextprotocol/ext-apps
   - Define Invoice interface (id, document_nr, title, contact, positions array, total_gross, currency_id, is_valid_from, is_valid_until, kb_item_status_id)
   - Create App instance with name "Invoice Preview"
   - Implement app.ontoolresult to parse JSON and call renderInvoice()
   - Call app.connect()
   - Implement renderInvoice(invoice) that sets innerHTML with formatted data

4. Create contact-card.html:
   - Inline CSS for card layout (rounded corners, shadow, max-width 400px)
   - Contact name header (name_1 + name_2)
   - Company section (if company)
   - Contact details (email, phone, fax)
   - Address section (address, postcode, city, country)
   - Script module import for mcp-app.ts

5. Create contact-card/mcp-app.ts:
   - Import App from @modelcontextprotocol/ext-apps
   - Define Contact interface (id, name_1, name_2, mail, phone_fixed, phone_mobile, fax, address, postcode, city, country_id)
   - Handle ontoolresult, parse JSON, call renderContact()
   - Implement renderContact(contact) with formatted HTML

6. Create dashboard.html:
   - Inline CSS for dashboard grid layout (3 columns on lg, 1 on mobile)
   - Summary cards: Open Invoices, Overdue, Recent Contacts
   - Script module import for mcp-app.ts

7. Create dashboard/mcp-app.ts:
   - Import App from @modelcontextprotocol/ext-apps
   - Define DashboardData interface (open_invoices_count, open_invoices_total, overdue_count, overdue_total, recent_contacts array, currency)
   - Handle ontoolresult, parse JSON, call renderDashboard()
   - Implement renderDashboard(data) with formatted cards
  </action>
  <verify>All 6 files exist; HTML files have DOCTYPE and script imports; TS files import App from ext-apps</verify>
  <done>Three UI templates created with HTML + TypeScript client scripts</done>
</task>

<task type="auto">
  <name>Task 3: Register UI resources and tools in server</name>
  <files>src/ui-resources.ts, src/server.ts</files>
  <action>
1. Create src/ui-resources.ts:
   - Import McpServer from @modelcontextprotocol/sdk/server/mcp.js
   - Import registerAppTool, registerAppResource, RESOURCE_MIME_TYPE from @modelcontextprotocol/ext-apps/server
   - Import fs/promises and path from node:
   - Import BexioClient from ./bexio-client.js

   Define three UI resource URIs:
   - const INVOICE_PREVIEW_URI = "ui://bexio/invoice-preview.html"
   - const CONTACT_CARD_URI = "ui://bexio/contact-card.html"
   - const DASHBOARD_URI = "ui://bexio/dashboard.html"

   Export function registerUIResources(server: McpServer, client: BexioClient):

   Register preview_invoice tool:
   - Use registerAppTool with inputSchema { invoice_id: integer }
   - Set _meta.ui.resourceUri to INVOICE_PREVIEW_URI
   - Handler: await client.get("/kb_invoice/{invoice_id}"), return JSON in content

   Register preview_invoice resource:
   - Use registerAppResource for INVOICE_PREVIEW_URI
   - Read dist/ui/invoice-preview.html using fs.readFile
   - Use import.meta.dirname for path resolution
   - Return contents array with mimeType: RESOURCE_MIME_TYPE

   Register show_contact_card tool:
   - Use registerAppTool with inputSchema { contact_id: integer }
   - Set _meta.ui.resourceUri to CONTACT_CARD_URI
   - Handler: await client.get("/contact/{contact_id}"), return JSON

   Register show_contact_card resource:
   - Read dist/ui/contact-card.html

   Register show_dashboard tool:
   - Use registerAppTool with inputSchema {} (no params)
   - Set _meta.ui.resourceUri to DASHBOARD_URI
   - Handler: Fetch open invoices (kb_invoice_status_id=7,8), count overdue, get recent contacts
   - Return aggregated DashboardData JSON

   Register show_dashboard resource:
   - Read dist/ui/dashboard.html

2. Update src/server.ts:
   - Import registerUIResources from ./ui-resources.js
   - In initialize() method, after registerTools(), call registerUIResources(this.server, client)
   - Pass this.server (McpServer instance) and client (BexioClient)
  </action>
  <verify>TypeScript compiles without errors; grep for registerUIResources in server.ts returns match</verify>
  <done>UI resources registered; server integrates MCP Apps capability</done>
</task>

</tasks>

<verification>
1. Build completes: `cd src && npm run build` succeeds
2. UI files exist: `ls dist/ui/*.html` shows 3 files
3. TypeScript valid: `npm run type-check` passes
4. Tool registration: Start server, check logs show UI tools registered
</verification>

<success_criteria>
- src/package.json includes @modelcontextprotocol/ext-apps and vite dependencies
- vite.config.ts exists and bundles UI to dist/ui/
- Three HTML templates created in src/ui/
- ui-resources.ts exports registerUIResources function
- server.ts calls registerUIResources during initialization
- Build produces dist/ui/*.html files (single-file bundles)
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-packaging/05-01-SUMMARY.md`
</output>
