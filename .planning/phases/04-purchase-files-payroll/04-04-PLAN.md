---
phase: 04-purchase-files-payroll
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/schemas/payroll.ts
  - src/types/schemas/index.ts
  - src/bexio-client.ts
  - src/tools/payroll/definitions.ts
  - src/tools/payroll/handlers.ts
  - src/tools/payroll/index.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "User can list, view, create, and update employees (when payroll module active)"
    - "User can list, view, create, update, and delete absences (when payroll module active)"
    - "User can list payroll documents (when payroll module active)"
    - "User receives friendly error message when payroll module is not available"
  artifacts:
    - path: "src/types/schemas/payroll.ts"
      provides: "Zod schemas for employees, absences, and payroll documents"
      exports: ["ListEmployeesParamsSchema", "GetEmployeeParamsSchema", "CreateEmployeeParamsSchema", "UpdateEmployeeParamsSchema", "ListAbsencesParamsSchema", "GetAbsenceParamsSchema", "CreateAbsenceParamsSchema", "UpdateAbsenceParamsSchema", "DeleteAbsenceParamsSchema", "ListPayrollDocumentsParamsSchema"]
    - path: "src/tools/payroll/handlers.ts"
      provides: "Handler implementations with module detection"
      min_lines: 100
      contains: "payrollModuleAvailable"
  key_links:
    - from: "src/tools/payroll/handlers.ts"
      to: "checkPayrollModule"
      via: "Module availability check before all operations"
      pattern: "checkPayrollModule.*client"
    - from: "src/tools/payroll/handlers.ts"
      to: "payrollUnavailableError"
      via: "Friendly error for unavailable module"
      pattern: "Payroll module is not enabled"
---

<objective>
Implement conditional payroll tools with module detection.

Purpose: Enable users to manage employees and absences when Bexio payroll module is subscribed, with friendly error messages when unavailable. Uses probe-on-first-call pattern with cached result.

Output: 10 new tools - employees (4) + absences (5) + payroll documents (1), plus module detection logic with friendly errors.
</objective>

<execution_context>
@C:\Users\calvi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\calvi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-purchase-files-payroll/04-RESEARCH.md
@.planning/phases/04-purchase-files-payroll/04-CONTEXT.md

# Established patterns
@src/tools/contacts/definitions.ts
@src/tools/contacts/handlers.ts
@src/shared/errors.ts
@src/bexio-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payroll schemas and BexioClient methods</name>
  <files>
    src/types/schemas/payroll.ts
    src/types/schemas/index.ts
    src/bexio-client.ts
  </files>
  <action>
Create payroll.ts schema file and add BexioClient methods:

1. Create `src/types/schemas/payroll.ts` with Zod schemas:
   - Employees: ListEmployeesParamsSchema, GetEmployeeParamsSchema, CreateEmployeeParamsSchema, UpdateEmployeeParamsSchema
   - Absences: ListAbsencesParamsSchema (optional year filter), GetAbsenceParamsSchema, CreateAbsenceParamsSchema, UpdateAbsenceParamsSchema, DeleteAbsenceParamsSchema
   - Payroll Documents: ListPayrollDocumentsParamsSchema (optional employee_id filter)

2. Update `src/types/schemas/index.ts` to export payroll schemas

3. Add BexioClient methods:
   - Employees: listEmployees, getEmployee, createEmployee, updateEmployee
   - Endpoint: /employee
   - Absences: listAbsences, getAbsence, createAbsence, updateAbsence, deleteAbsence
   - Endpoint: /absence
   - Payroll Documents: listPayrollDocuments
   - Endpoint: /payroll_document (or similar - may need to verify)

Note: These methods will be called by handlers that first check module availability. The client methods themselves don't need special handling - errors will be caught by handlers.
  </action>
  <verify>
    npm run build passes with no TypeScript errors
  </verify>
  <done>
    - payroll.ts exports 10 Zod schemas
    - schemas/index.ts exports payroll module
    - BexioClient has 10 new methods for payroll operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Create payroll tool definitions and handlers with module detection</name>
  <files>
    src/tools/payroll/definitions.ts
    src/tools/payroll/handlers.ts
    src/tools/payroll/index.ts
    src/tools/index.ts
  </files>
  <action>
Create the payroll domain module with module detection:

1. Create `src/tools/payroll/definitions.ts`:
   - 4 employee tools: list_employees, get_employee, create_employee, update_employee
   - 5 absence tools: list_absences, get_absence, create_absence, update_absence, delete_absence
   - 1 payroll document tool: list_payroll_documents
   - Tool descriptions should mention: "Requires Bexio Payroll module subscription"

2. Create `src/tools/payroll/handlers.ts` with module detection:
   - Add module cache (`let payrollModuleAvailable: boolean | null = null`) and helper functions at top of file
   - `checkPayrollModule`: Probe on first call (listEmployees with limit=1), cache result, check for 403/404 indicating unavailable
   - `payrollUnavailableError`: Return McpError with friendly message per CONTEXT.md: explain what's needed, link to settings URL, mention plan tiers
   - All handlers call checkPayrollModule first, throw friendly error if unavailable
   - Follow error handling pattern from src/shared/errors.ts

3. Create `src/tools/payroll/index.ts`:
   - Barrel export: toolDefinitions, handlers

4. Update `src/tools/index.ts`:
   - Import payroll module
   - Add to allDefinitions array (comment: "10 tools (employees, absences, payroll docs - conditional)")
   - Add to allHandlers object
   - Update total count (208 + 10 = 218)

IMPORTANT: Follow CONTEXT.md decision - friendly error messages, not technical/terse. Explain the situation helpfully.
  </action>
  <verify>
    npm run build passes and verify 10 payroll tools exist: `node -e "const t = require('./dist/tools/index.js'); const n = t.getAllToolDefinitions().filter(d => d.name.includes('employee') || d.name.includes('absence') || d.name.includes('payroll')).length; console.log('Payroll tools:', n); if(n !== 10) process.exit(1);"`
  </verify>
  <done>
    - definitions.ts exports 10 tool definitions
    - handlers.ts exports 10 handler functions with module detection
    - Module detection probes on first call, caches result
    - Friendly error message when module unavailable
    - tools/index.ts aggregates payroll module
    - Total tool count: 218
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Module detection uses probe-on-first-call pattern
3. Error message is user-friendly (per CONTEXT.md)
4. All 10 new tools appear in aggregated list
5. Tools remain visible but return helpful error when module unavailable
</verification>

<success_criteria>
- 10 new tools: 4 employee + 5 absence + 1 payroll document tools
- Module detection with probe-on-first-call pattern
- Friendly error messages when module unavailable
- Build passes, no TypeScript errors
- Total tools: 218 (175 + 43 from Phase 4)
</success_criteria>

<output>
After completion, create `.planning/phases/04-purchase-files-payroll/04-04-SUMMARY.md`
</output>
