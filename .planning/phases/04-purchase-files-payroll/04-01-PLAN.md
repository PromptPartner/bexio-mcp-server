---
phase: 04-purchase-files-payroll
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/schemas/purchase.ts
  - src/types/schemas/index.ts
  - src/bexio-client.ts
  - src/tools/purchase/definitions.ts
  - src/tools/purchase/handlers.ts
  - src/tools/purchase/index.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "User can list, view, create, update, and delete bills (creditor invoices)"
    - "User can search bills by criteria"
    - "User can issue bills and mark them as paid"
    - "User can list, view, create, update, and delete expenses"
  artifacts:
    - path: "src/types/schemas/purchase.ts"
      provides: "Zod schemas for bills and expenses"
      exports: ["ListBillsParamsSchema", "GetBillParamsSchema", "CreateBillParamsSchema", "UpdateBillParamsSchema", "DeleteBillParamsSchema", "SearchBillsParamsSchema", "IssueBillParamsSchema", "MarkBillAsPaidParamsSchema", "ListExpensesParamsSchema", "GetExpenseParamsSchema", "CreateExpenseParamsSchema", "UpdateExpenseParamsSchema", "DeleteExpenseParamsSchema"]
    - path: "src/tools/purchase/definitions.ts"
      provides: "13 tool definitions for bills and expenses"
      min_lines: 100
    - path: "src/tools/purchase/handlers.ts"
      provides: "Handler implementations for bills and expenses"
      min_lines: 80
  key_links:
    - from: "src/tools/purchase/handlers.ts"
      to: "src/bexio-client.ts"
      via: "BexioClient API methods"
      pattern: "client\\.(list|get|create|update|delete|search|issue|mark)Bill"
    - from: "src/tools/index.ts"
      to: "src/tools/purchase/index.ts"
      via: "module import and aggregation"
      pattern: "import.*purchase"
---

<objective>
Implement bills (creditor invoices) and expenses tools for the purchase cycle.

Purpose: Enable users to manage supplier bills and track business expenses through Claude Desktop, completing the procurement side of Bexio accounting (mirrors sales invoices from Phase 1).

Output: 13 new tools - bills CRUD (6), bill actions (2), expenses CRUD (5), plus schemas and BexioClient methods.
</objective>

<execution_context>
@C:\Users\calvi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\calvi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-purchase-files-payroll/04-RESEARCH.md

# Established patterns
@src/tools/invoices/definitions.ts
@src/tools/invoices/handlers.ts
@src/types/schemas/invoices.ts
@src/bexio-client.ts
@src/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create purchase schemas and BexioClient methods</name>
  <files>
    src/types/schemas/purchase.ts
    src/types/schemas/index.ts
    src/bexio-client.ts
  </files>
  <action>
Create purchase.ts schema file following the established pattern from invoices.ts:

1. Create `src/types/schemas/purchase.ts` with Zod schemas:
   - Bills: ListBillsParamsSchema, GetBillParamsSchema, CreateBillParamsSchema, UpdateBillParamsSchema, DeleteBillParamsSchema, SearchBillsParamsSchema, IssueBillParamsSchema, MarkBillAsPaidParamsSchema
   - Expenses: ListExpensesParamsSchema, GetExpenseParamsSchema, CreateExpenseParamsSchema, UpdateExpenseParamsSchema, DeleteExpenseParamsSchema
   - Use standard pagination pattern (limit/offset with defaults)
   - Use bill_id/expense_id as number().int().positive()
   - Use bill_data/expense_data as z.record(z.unknown()) for create/update
   - Search uses z.array(z.record(z.unknown())) for criteria array

2. Update `src/types/schemas/index.ts` to export purchase schemas

3. Add BexioClient methods for bills and expenses (add to existing file):
   - Bills: listBills, getBill, createBill, updateBill, deleteBill, searchBills, issueBill, markBillAsPaid
   - Expenses: listExpenses, getExpense, createExpense, updateExpense, deleteExpense
   - Endpoints: /kb_bill for bills, /kb_expense for expenses
   - Bill actions: POST /kb_bill/{id}/issue, POST /kb_bill/{id}/mark_as_paid

Follow the exact pattern from invoices methods in bexio-client.ts. Use POST for updates (Bexio convention).
  </action>
  <verify>
    npm run build passes with no TypeScript errors
  </verify>
  <done>
    - purchase.ts exports 13 Zod schemas
    - schemas/index.ts exports purchase module
    - BexioClient has 13 new methods for bills and expenses
  </done>
</task>

<task type="auto">
  <name>Task 2: Create purchase tool definitions and handlers</name>
  <files>
    src/tools/purchase/definitions.ts
    src/tools/purchase/handlers.ts
    src/tools/purchase/index.ts
    src/tools/index.ts
  </files>
  <action>
Create the purchase domain module following the established pattern:

1. Create `src/tools/purchase/definitions.ts`:
   - 13 tool definitions: list_bills, get_bill, create_bill, update_bill, delete_bill, search_bills, issue_bill, mark_bill_as_paid, list_expenses, get_expense, create_expense, update_expense, delete_expense
   - Use empty inputSchema (validation in handlers per established pattern)
   - Follow exact naming pattern from invoices/definitions.ts
   - Descriptions should be user-friendly, mention "creditor invoice" for bills

2. Create `src/tools/purchase/handlers.ts`:
   - Import schemas from types/schemas/purchase
   - Implement all 13 handlers using BexioClient methods
   - Use McpError.notFound() for missing resources
   - Follow exact pattern from invoices/handlers.ts

3. Create `src/tools/purchase/index.ts`:
   - Barrel export: toolDefinitions, handlers

4. Update `src/tools/index.ts`:
   - Import purchase module
   - Add to allDefinitions array (comment: "# tools (bills, expenses)")
   - Add to allHandlers object
   - Update total count in comment

Tool naming convention (maintain backward compatibility with any v1 names if they exist, otherwise use standard pattern):
- list_bills, get_bill, create_bill, update_bill, delete_bill, search_bills
- issue_bill, mark_bill_as_paid
- list_expenses, get_expense, create_expense, update_expense, delete_expense
  </action>
  <verify>
    npm run build passes and verify 13 purchase tools exist: `node -e "const t = require('./dist/tools/index.js'); const n = t.getAllToolDefinitions().filter(d => d.name.includes('bill') || d.name.includes('expense')).length; console.log('Purchase tools:', n); if(n !== 13) process.exit(1);"`
  </verify>
  <done>
    - definitions.ts exports 13 tool definitions
    - handlers.ts exports 13 handler functions
    - tools/index.ts aggregates purchase module
    - Total tool count increases by 13 (175 -> 188)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Type check passes with no warnings
3. New tools appear in aggregated list
4. No console.log statements in new code (only console.error for logging)
</verification>

<success_criteria>
- 13 new tools: 8 bill tools + 5 expense tools
- All tools follow established patterns (empty inputSchema, validation in handlers)
- BexioClient has all API methods for bills and expenses
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-purchase-files-payroll/04-01-SUMMARY.md`
</output>
