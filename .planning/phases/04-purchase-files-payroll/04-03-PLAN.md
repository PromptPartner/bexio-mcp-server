---
phase: 04-purchase-files-payroll
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/schemas/files.ts
  - src/types/schemas/index.ts
  - src/bexio-client.ts
  - src/tools/files/definitions.ts
  - src/tools/files/handlers.ts
  - src/tools/files/index.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "User can list, view, upload, update, and delete files"
    - "User can download file content as base64"
    - "User can manage additional addresses for contacts"
  artifacts:
    - path: "src/types/schemas/files.ts"
      provides: "Zod schemas for files and additional addresses"
      exports: ["ListFilesParamsSchema", "GetFileParamsSchema", "UploadFileParamsSchema", "DownloadFileParamsSchema", "UpdateFileParamsSchema", "DeleteFileParamsSchema", "ListAdditionalAddressesParamsSchema", "GetAdditionalAddressParamsSchema", "CreateAdditionalAddressParamsSchema", "DeleteAdditionalAddressParamsSchema"]
    - path: "src/tools/files/definitions.ts"
      provides: "10 tool definitions for files and additional addresses"
      min_lines: 80
    - path: "src/tools/files/handlers.ts"
      provides: "Handler implementations with binary handling"
      min_lines: 80
  key_links:
    - from: "src/tools/files/handlers.ts"
      to: "src/bexio-client.ts"
      via: "BexioClient API methods with binary handling"
      pattern: "client\\.(list|get|upload|download|update|delete)File"
    - from: "src/bexio-client.ts"
      to: "Buffer.from"
      via: "Base64 encoding for MCP transport"
      pattern: "Buffer\\.from.*base64"
---

<objective>
Implement file management and additional addresses tools.

Purpose: Enable users to upload, download, and manage documents in Bexio, plus manage additional addresses for contacts. Files use base64 encoding for MCP JSON transport.

Output: 10 new tools - files CRUD + download (6) + additional addresses (4), plus schemas and BexioClient methods with binary handling.
</objective>

<execution_context>
@C:\Users\calvi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\calvi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-purchase-files-payroll/04-RESEARCH.md

# Established patterns
@src/tools/contacts/definitions.ts
@src/tools/contacts/handlers.ts
@src/bexio-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create files schemas and BexioClient methods with binary handling</name>
  <files>
    src/types/schemas/files.ts
    src/types/schemas/index.ts
    src/bexio-client.ts
  </files>
  <action>
Create files.ts schema file and add BexioClient methods with binary support:

1. Create `src/types/schemas/files.ts` with Zod schemas:
   - Files: ListFilesParamsSchema, GetFileParamsSchema, UploadFileParamsSchema (name, content_base64, content_type), DownloadFileParamsSchema, UpdateFileParamsSchema, DeleteFileParamsSchema
   - Additional Addresses: ListAdditionalAddressesParamsSchema (requires contact_id), GetAdditionalAddressParamsSchema (contact_id + address_id), CreateAdditionalAddressParamsSchema (contact_id + address_data), DeleteAdditionalAddressParamsSchema (contact_id + address_id)

2. Update `src/types/schemas/index.ts` to export files schemas

3. Add BexioClient methods:
   - Files: listFiles, getFile, uploadFile, downloadFile, updateFile, deleteFile
   - Endpoint: /file
   - uploadFile: Accept base64 content, convert to Buffer, use multipart/form-data
   - downloadFile: Return content as base64 string for MCP JSON transport
   - Additional Addresses: listAdditionalAddresses, getAdditionalAddress, createAdditionalAddress, deleteAdditionalAddress
   - Endpoint: /contact/{contact_id}/additional_address

For uploadFile implementation:
```typescript
async uploadFile(data: { name: string; content_base64: string; content_type: string }): Promise<unknown> {
  const buffer = Buffer.from(data.content_base64, "base64");
  // Use axios FormData for multipart upload
  const FormData = (await import("form-data")).default;
  const formData = new FormData();
  formData.append("file", buffer, {
    filename: data.name,
    contentType: data.content_type,
  });
  return this.client.post("/file", formData, {
    headers: formData.getHeaders(),
  }).then(r => r.data);
}
```

For downloadFile implementation:
```typescript
async downloadFile(fileId: number): Promise<string> {
  const response = await this.client.get(`/file/${fileId}/download`, {
    responseType: "arraybuffer",
  });
  return Buffer.from(response.data).toString("base64");
}
```

NOTE: May need to add `form-data` package if not already available. Check package.json first - if not present, add the import dynamically or use built-in FormData if available in Node 18+.
  </action>
  <verify>
    npm run build passes with no TypeScript errors
  </verify>
  <done>
    - files.ts exports 10 Zod schemas
    - schemas/index.ts exports files module
    - BexioClient has 10 new methods including binary handling for upload/download
  </done>
</task>

<task type="auto">
  <name>Task 2: Create files tool definitions and handlers</name>
  <files>
    src/tools/files/definitions.ts
    src/tools/files/handlers.ts
    src/tools/files/index.ts
    src/tools/index.ts
  </files>
  <action>
Create the files domain module:

1. Create `src/tools/files/definitions.ts`:
   - 6 file tools: list_files, get_file, upload_file, download_file, update_file, delete_file
   - 4 additional address tools: list_additional_addresses, get_additional_address, create_additional_address, delete_additional_address
   - Upload tool description should mention base64 encoding requirement
   - Download tool description should mention base64 return format

2. Create `src/tools/files/handlers.ts`:
   - Import schemas from types/schemas/files
   - Implement all 10 handlers
   - download_file handler returns structured response: { file_id, content_base64, message: "File content returned as base64 encoded string" }
   - Use McpError.notFound() for missing resources

3. Create `src/tools/files/index.ts`:
   - Barrel export: toolDefinitions, handlers

4. Update `src/tools/index.ts`:
   - Import files module
   - Add to allDefinitions array (comment: "10 tools (files, additional addresses)")
   - Add to allHandlers object
   - Update total count (198 + 10 = 208)
  </action>
  <verify>
    npm run build passes and `npm run build && node -e "const t = require('./dist/tools/index.js'); console.log('File tools:', t.getAllToolDefinitions().filter(d => d.name.includes('file') || d.name.includes('additional_address')).map(d => d.name))"` shows all 10 tools
  </verify>
  <done>
    - definitions.ts exports 10 tool definitions
    - handlers.ts exports 10 handler functions
    - tools/index.ts aggregates files module
    - Total tool count: 208
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Upload tool accepts base64 content
3. Download tool returns base64 content
4. Additional addresses linked to contacts via contact_id
5. All 10 new tools appear in aggregated list
</verification>

<success_criteria>
- 10 new tools: 6 file tools + 4 additional address tools
- Binary handling via base64 encoding for MCP JSON transport
- Build passes, no TypeScript errors
- Total tools: 208
</success_criteria>

<output>
After completion, create `.planning/phases/04-purchase-files-payroll/04-03-SUMMARY.md`
</output>
