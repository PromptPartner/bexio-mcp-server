---
phase: 04-purchase-files-payroll
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/schemas/purchase.ts
  - src/bexio-client.ts
  - src/tools/purchase/definitions.ts
  - src/tools/purchase/handlers.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "User can list, view, create, update, and delete purchase orders"
    - "User can list, view, create, update, and delete outgoing payments linked to bills"
  artifacts:
    - path: "src/types/schemas/purchase.ts"
      provides: "Additional schemas for purchase orders and outgoing payments"
      exports: ["ListPurchaseOrdersParamsSchema", "GetPurchaseOrderParamsSchema", "CreatePurchaseOrderParamsSchema", "UpdatePurchaseOrderParamsSchema", "DeletePurchaseOrderParamsSchema", "ListOutgoingPaymentsParamsSchema", "GetOutgoingPaymentParamsSchema", "CreateOutgoingPaymentParamsSchema", "UpdateOutgoingPaymentParamsSchema", "DeleteOutgoingPaymentParamsSchema"]
    - path: "src/tools/purchase/definitions.ts"
      provides: "10 additional tool definitions for purchase orders and outgoing payments"
      min_lines: 150
    - path: "src/tools/purchase/handlers.ts"
      provides: "10 additional handler implementations"
      min_lines: 140
  key_links:
    - from: "src/tools/purchase/handlers.ts"
      to: "src/bexio-client.ts"
      via: "BexioClient API methods for purchase orders and outgoing payments"
      pattern: "client\\.(list|get|create|update|delete)(PurchaseOrder|OutgoingPayment)"
    - from: "src/tools/purchase/handlers.ts"
      to: "/kb_bill/{id}/payment"
      via: "Nested URL pattern for outgoing payments"
      pattern: "bill_id.*payment"
---

<objective>
Implement purchase orders and outgoing payments tools.

Purpose: Enable users to manage purchase orders and track outgoing payments linked to bills, completing the full procurement cycle (purchase orders -> bills -> payments).

Output: 10 new tools - purchase orders CRUD (5) + outgoing payments CRUD (5), plus schemas and BexioClient methods.
</objective>

<execution_context>
@C:\Users\calvi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\calvi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-purchase-files-payroll/04-RESEARCH.md

# Established patterns for nested resources and payments
@src/tools/payments/definitions.ts
@src/tools/payments/handlers.ts
@src/tools/projects/handlers.ts
@src/bexio-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add purchase order and outgoing payment schemas and client methods</name>
  <files>
    src/types/schemas/purchase.ts
    src/bexio-client.ts
  </files>
  <action>
Extend purchase.ts and BexioClient with purchase orders and outgoing payments:

1. Add to `src/types/schemas/purchase.ts`:
   - Purchase Orders: ListPurchaseOrdersParamsSchema, GetPurchaseOrderParamsSchema, CreatePurchaseOrderParamsSchema, UpdatePurchaseOrderParamsSchema, DeletePurchaseOrderParamsSchema
   - Outgoing Payments (linked to bills): ListOutgoingPaymentsParamsSchema (requires bill_id), GetOutgoingPaymentParamsSchema (requires bill_id + payment_id), CreateOutgoingPaymentParamsSchema (requires bill_id + payment_data), UpdateOutgoingPaymentParamsSchema (requires bill_id + payment_id + payment_data), DeleteOutgoingPaymentParamsSchema (requires bill_id + payment_id)

2. Add BexioClient methods:
   - Purchase Orders: listPurchaseOrders, getPurchaseOrder, createPurchaseOrder, updatePurchaseOrder, deletePurchaseOrder
   - Endpoint: /purchase_order
   - Outgoing Payments: listOutgoingPayments, getOutgoingPayment, createOutgoingPayment, updateOutgoingPayment, deleteOutgoingPayment
   - Endpoint: /kb_bill/{bill_id}/payment (nested under bills, like incoming payments under invoices)

IMPORTANT: Outgoing payments use nested URL pattern `/kb_bill/{id}/payment` - follow the same pattern as incoming payments in the existing payments domain (`/kb_invoice/{id}/payment`).
  </action>
  <verify>
    npm run build passes with no TypeScript errors
  </verify>
  <done>
    - purchase.ts has 10 additional schemas (total 23 in file)
    - BexioClient has 10 new methods for purchase orders and outgoing payments
  </done>
</task>

<task type="auto">
  <name>Task 2: Add purchase order and outgoing payment tool definitions and handlers</name>
  <files>
    src/tools/purchase/definitions.ts
    src/tools/purchase/handlers.ts
    src/tools/index.ts
  </files>
  <action>
Extend purchase domain module with purchase orders and outgoing payments:

1. Add to `src/tools/purchase/definitions.ts`:
   - 5 purchase order tools: list_purchase_orders, get_purchase_order, create_purchase_order, update_purchase_order, delete_purchase_order
   - 5 outgoing payment tools: list_outgoing_payments, get_outgoing_payment, create_outgoing_payment, update_outgoing_payment, delete_outgoing_payment
   - Total in file: 23 tool definitions

2. Add to `src/tools/purchase/handlers.ts`:
   - Implement all 10 new handlers
   - For outgoing payments, pass bill_id to all BexioClient calls (nested resource pattern)
   - Use McpError.notFound() for missing resources

3. Update `src/tools/index.ts`:
   - Update comment to reflect new tool count (23 tools for purchase domain)
   - Update total count (188 + 10 = 198)

Tool descriptions for outgoing payments should mention they're linked to bills (creditor invoices), e.g., "List all outgoing payments for a specific bill (creditor invoice)".
  </action>
  <verify>
    npm run build passes and `npm run build && node -e "const t = require('./dist/tools/index.js'); console.log('Purchase orders:', t.getAllToolDefinitions().filter(d => d.name.includes('purchase_order')).length); console.log('Outgoing payments:', t.getAllToolDefinitions().filter(d => d.name.includes('outgoing_payment')).length);"` shows 5 purchase orders and 5 outgoing payments tools
  </verify>
  <done>
    - definitions.ts exports 23 tool definitions total
    - handlers.ts exports 23 handler functions total
    - tools/index.ts shows 198 total tools
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Purchase orders use /purchase_order endpoint
3. Outgoing payments use nested /kb_bill/{id}/payment endpoint
4. All 10 new tools appear in aggregated list
</verification>

<success_criteria>
- 10 new tools: 5 purchase order tools + 5 outgoing payment tools
- Outgoing payments correctly linked to bills (nested URL pattern)
- Build passes, no TypeScript errors
- Total tools: 198
</success_criteria>

<output>
After completion, create `.planning/phases/04-purchase-files-payroll/04-02-SUMMARY.md`
</output>
